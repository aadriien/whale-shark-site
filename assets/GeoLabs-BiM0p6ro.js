import{r as o,j as t,a as k,b as W,R as q,c as $,p as Y,d as K,m as Q}from"./index-DK2bq1kE.js";import{b as G,d as U,c as T,e as E,a as P,F as X,g as O,G as Z}from"./FavoriteButton-DoR99yIe.js";import{P as _}from"./PlayStoryButton-Cv_PF69X.js";import{u as L,S as ee,a as te}from"./GlobeClick-zlwWKHKq.js";import{D as ne,H as se,C as ae,S as re}from"./SexLifeStageData-B3khznzN.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";const ie=({shark:e,onStepChange:s,currentStepIndex:a,isVisible:i})=>{const[r,f]=o.useState([]);if(o.useEffect(()=>{if(e){const n=G(e.id);f(n),i&&n.length===1&&s(0,n[0])}},[e,i,s]),!i||!e||r.length===0)return null;const m=n=>{const x=parseInt(n.target.value),y=r[x];s(x,y)},c=()=>{if(a>0){const n=a-1;s(n,r[n])}},l=()=>{if(a<r.length-1){const n=a+1;s(n,r[n])}},d=r[a];return t.jsx("div",{className:"story-step-container",children:t.jsxs("div",{className:"story-slider-section",children:[t.jsxs("h4",{children:["Point ",a+1," of ",r.length,d&&t.jsxs("span",{className:"step-date-header",children:[" ... ",d.date||"Unknown date"]})]}),t.jsxs("div",{className:"slider-controls",children:[t.jsx("button",{className:"step-button",onClick:c,disabled:a===0,children:"-"}),t.jsx("input",{type:"range",min:"0",max:r.length-1,value:a,onChange:m,className:"story-slider"}),t.jsx("button",{className:"step-button",onClick:l,disabled:a===r.length-1,children:"+"})]})]})})},le=({onToggleTimelineMode:e,isTimelineMode:s=!1})=>t.jsx("div",{className:"timeline-mode-section",children:t.jsx("button",{className:`geo-labs-timeline-button
                    ${s?" timeline-mode-active":""}
                `,onClick:a=>{a.stopPropagation(),e()},children:s?"Exit Timeline Mode":t.jsxs(t.Fragment,{children:["Explore Shark Data ",t.jsx("strong",{children:"Timeline"})]})})}),oe=({onTimelineChange:e,currentMonth:s,currentYear:a,isVisible:i,availableSharks:r=[],plottedCoordinates:f=[]})=>{const m=()=>{const S=new Set;return U.forEach(v=>{(r.length===0||r.includes(v.whaleSharkID))&&v.coordinates.forEach(b=>{if(b.parsedDate){const C=new Date(b.parsedDate),D=C.getFullYear(),M=C.getMonth()+1;!isNaN(D)&&!isNaN(M)&&S.add(`${D}-${M.toString().padStart(2,"0")}`)}})}),Array.from(S).sort()},c=o.useMemo(()=>m(),[r]),l=()=>{if(c.length===0)return 0;const S=`${a||new Date().getFullYear()}-${(s||new Date().getMonth()+1).toString().padStart(2,"0")}`,v=c.indexOf(S);return v>=0?v:0},[d,n]=o.useState(l),x=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],u=(S=>{if(c.length===0)return{month:1,year:new Date().getFullYear()};const v=c[S]||c[0],[b,C]=v.split("-").map(Number);return{month:C,year:b}})(d),g=o.useMemo(()=>{if(!f||f.length===0)return[];const S=new Set;return f.forEach(v=>{if(v.id){const b=v.id.split("-")[0];S.add(b)}}),Array.from(S).sort((v,b)=>v.localeCompare(b))},[f]);if(o.useEffect(()=>{if(i&&c.length>0){const{month:S,year:v}=u;e(S,v)}},[d,i,e,c.length]),!i||c.length===0)return null;const j=S=>{const v=parseInt(S.target.value);n(v)},p=()=>{d>0&&n(d-1)},w=()=>{d<c.length-1&&n(d+1)},N=d>0,A=d<c.length-1;return t.jsxs("div",{className:"timeline-selector-container",children:[t.jsxs("div",{className:"timeline-navigation",children:[t.jsx("button",{className:"timeline-nav-button",onClick:p,disabled:!N,title:"Previous month",children:"←"}),t.jsxs("div",{className:"timeline-date-display",children:[x[u.month-1]," ",u.year]}),t.jsx("button",{className:"timeline-nav-button",onClick:w,disabled:!A,title:"Next month",children:"→"})]}),t.jsx("div",{className:"timeline-slider-section",children:t.jsx("input",{type:"range",min:"0",max:c.length-1,value:d,onChange:j,className:"timeline-slider"})}),t.jsxs("div",{className:"timeline-info",children:["Showing map data from ",x[u.month-1]," ",u.year]}),g.length>0&&t.jsxs("div",{className:"timeline-sharks-display",children:[t.jsxs("div",{className:"sharks-list-title",children:["Plotting ",g.length," whale shark",g.length!==1?"s":"",":"]}),t.jsx("div",{className:"selected-sharks-list",children:Array.from(g).join(", ")})]})]})},ce=({globeRef:e,selectedSharksForLab:s,onToggleTimelineMode:a,isTimelineMode:i,onTimelineStateChange:r})=>{const[f,m]=o.useState(null),[c,l]=o.useState(null),[d,n]=o.useState([]),x=()=>{i&&(m(null),l(null),n([])),a(),r==null||r(!1)},y=o.useCallback((g,j)=>{if(m(g),l(j),console.log(`Timeline changed to: ${g}/${j}`),e.current&&g&&j){const p=e.current.getGlobe();T(p);const w=k();let N;s.size>0?N=E(Array.from(s),g,j):N=E(w,g,j),n(N),P(p,N)}},[e,s]),u=()=>s.size>0?Array.from(s):k();return t.jsxs("div",{className:"timeline-controls-container",children:[t.jsx(le,{onToggleTimelineMode:x,isTimelineMode:i}),t.jsx(oe,{onTimelineChange:y,currentMonth:f,currentYear:c,isVisible:i,availableSharks:u(),plottedCoordinates:d})]})},de=({shark:e})=>{const s=e.image!=="Unknown"?W(e.image):[];return t.jsxs("div",{className:"shark-banner",children:[t.jsx("div",{className:"tiny-banner-media",children:s.length>0?t.jsx("img",{src:s[0].url,alt:`Image of shark ${e.id}`}):t.jsx("span",{className:"no-image",children:"N/A"})}),t.jsxs("div",{className:"tiny-id-row",children:[t.jsx("strong",{children:e.id}),t.jsx(X,{sharkId:e.id})]})]})};function ue({sharks:e,onSelect:s,selectedSharkId:a,viewMode:i,selectedSharksForLab:r,onLabSelectionChange:f}){const[m,c]=o.useState(new Set),[l,d]=o.useState(!1);o.useEffect(()=>{const u=()=>{c($()),d(!0)};return u(),window.addEventListener("storage",u),window.addEventListener("favoritesChanged",u),()=>{window.removeEventListener("storage",u),window.removeEventListener("favoritesChanged",u)}},[]);const n=o.useMemo(()=>{if(m.size===0)return[];const u=new Map(e.map(g=>[g.id,g]));return[...m].map(g=>u.get(g)).filter(Boolean).sort((g,j)=>g.id.localeCompare(j.id))},[e,m]),x=u=>{i==="multiple"?y(u.id):s&&s(u.id)},y=q.useCallback(u=>{if(f&&r){const g=new Set(r);g.has(u)?g.delete(u):g.add(u),f(g)}},[f,r]);return t.jsxs("div",{className:"saved-sharks-display",children:[t.jsx("div",{className:"saved-sharks-header",children:t.jsxs("h3",{children:["Saved Sharks (",n.length,")"]})}),n.length>0?t.jsx("div",{className:"scrollable-shark-list",children:t.jsx("div",{className:"saved-sharks-grid",children:n.map(u=>{const g=r&&r.has(u.id);return t.jsx("div",{className:`saved-shark-card-wrapper ${i==="individual"&&u.id===a?"selected":""} ${i==="multiple"&&g?"selected-for-lab":""}`,onClick:()=>x(u),children:t.jsx(de,{shark:u})},u.id)})})}):l&&m.size===0?t.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",t.jsx("br",{}),t.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function he(e){if(e.country)return e.country;if(e.countries){const s=e.countries.split(",")[0];return Y(s)}return e["country (year)"]?Y(e["country (year)"]):"Unknown"}function me(e){if(e.year)return e.year;if(e.newest)return new Date(e.newest).getFullYear();if(e["Newest Occurrence"])return new Date(e["Newest Occurrence"]).getFullYear();if(e.oldest)return new Date(e.oldest).getFullYear();if(e["Oldest Occurrence"])return new Date(e["Oldest Occurrence"]).getFullYear();if(e.countries){const s=K(e.countries);if(s!=="Unknown"){const a=s.match(/(\d{4})/);if(a)return parseInt(a[1])}}return new Date().getFullYear()}function ge(e){if(e.publishing){const s=e.publishing.split(",")[0];return Y(s)}return e["publishingCountry (year)"]?Y(e["publishingCountry (year)"]):"Unknown"}function fe(e,s){if(!e||e.length===0)return[];const a=Array.isArray(e)?e:Array.from(e);if(a.length>0&&(typeof a[0]=="string"||typeof a[0]=="number")){const i=new Set(a.map(r=>String(r)));return s.filter(r=>i.has(String(r.whaleSharkID))||i.has(String(r.identificationID))||i.has(String(r.id)))}return a}function pe(e,s=[]){const a=fe(e,s);if(a.length===0)return[{lab:"No sharks selected","Total Selected":0,"Total Occurrences":0,Countries:"N/A",Years:"N/A","Top 3 Publishing Countries":"N/A"}];const i=new Set,r=new Set,f=new Map;let m=0;a.forEach(n=>{i.add(he(n)),r.add(me(n));const x=parseInt(n["Total Occurrences"])||parseInt(n.occurrences)||parseInt(n.TotalOccurrences)||1;m+=x;const y=ge(n);y!=="Unknown"&&f.set(y,(f.get(y)||0)+1)});const c=Array.from(f.entries()).sort((n,x)=>x[1]-n[1]).slice(0,3).map(([n])=>n).join(" > "),l=Array.from(r),d=Array.from(i);return[{lab:`${a.length} Selected Sharks`,"Total Selected":a.length,"Total Occurrences":m,Countries:d.slice(0,3).join(", ")+(d.length>3?"...":""),Years:l.length>0?`${Math.min(...l)} - ${Math.max(...l)}`:"N/A","Unique Countries":d.length,"Year Range":l.length>0?Math.max(...l)-Math.min(...l)+1:0,"Top 3 Publishing Countries":c||"Unknown"}]}function ve(e,s=[]){if(!e||e.length===0)return[];const a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=new Map;(Array.isArray(e)?e:Array.from(e)).forEach(m=>{const c=U.find(l=>l.whaleSharkID===m);c&&c.coordinates&&c.coordinates.forEach(l=>{if(l.eventDate){const d=new Date(l.eventDate);if(!isNaN(d.getTime())){const n=d.getFullYear(),x=a[d.getMonth()],y=`${n}-${x}`;i.set(y,(i.get(y)||0)+1)}}})});const f=[];for(const[m,c]of i.entries()){const[l,d]=m.split("-");f.push({year:parseInt(l),month:d,value:c})}return f}function xe({selectedSharksForLab:e,savedIds:s,sharks:a,onSelectAllToggle:i}){const r=o.useMemo(()=>{if(e.size===0)return[];const c=Array.from(e),l=a.filter(d=>c.includes(d.id));return pe(l)},[e,a]),f=o.useMemo(()=>e.size===0?[]:ve(e),[e]),m=o.useMemo(()=>{if(e.size===0)return[];const c=Array.from(e);return a.filter(l=>c.includes(l.id))},[e,a]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"multi-select-info",children:[t.jsxs("div",{className:"multi-select-header",children:[t.jsxs("h4",{children:["Selected for Lab (",e.size,"):"]}),t.jsxs("label",{className:"select-all-container",children:[t.jsx("input",{type:"checkbox",checked:e.size>0&&Array.from(s).every(c=>e.has(c)),onChange:i,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),t.jsx("div",{className:"selected-sharks-list",children:e.size>0?Array.from(e).join(", "):"None in lab"})]}),t.jsx("div",{className:"overview-container",children:t.jsx(ne,{dataset:r,filterField:"lab",selectedFilter:e.size>0?`${e.size} Selected Sharks`:"",displayFields:[{label:"Total Occurrences",field:"Total Occurrences"},{label:"Top 3 Publishing Countries",field:"Top 3 Publishing Countries"}]})}),t.jsx("div",{className:"heatmap-container",children:e.size>0&&f.length>0?t.jsx(se,{data:f,title:"Lab Sharks Record Timeline"}):t.jsx(ae,{type:"heatmap",message:"Add sharks to lab for heatmap"})}),t.jsx("div",{className:"radial-heatmap-container",children:t.jsx(re,{sharks:m})})]})}function Ae(){const[e,s]=o.useState(null),[a,i]=o.useState(!0),[r,f]=o.useState(new Set),[m,c]=o.useState("multiple"),[l,d]=o.useState(new Set),[n,x]=o.useState(!1),[y,u]=o.useState(0),[g,j]=o.useState(null),p=o.useRef(),[w,N]=o.useState(!1),[A,S]=o.useState(null),[v,b]=o.useState(null);o.useEffect(()=>{const h=()=>{f($())};return h(),window.addEventListener("storage",h),window.addEventListener("favoritesChanged",h),()=>{window.removeEventListener("storage",h),window.removeEventListener("favoritesChanged",h)}},[]);const C=o.useMemo(()=>{const h=k();return console.log("Plotting saved sharks on globe:",h),O(h)},[r]),D=o.useMemo(()=>{if(l.size===0)return[];const h=Array.from(l);return console.log("Plotting selected lab sharks on globe:",h),w&&A&&v?E(h,A,v):O(h)},[l,w,A,v]),M=Q;o.useEffect(()=>{if(!p.current)return;const h=p.current.getGlobe();if(T(h),n){i(!1);return}if(w){i(!1);return}m==="individual"?e?(p.current.highlightShark(e.id,!0),i(!1)):(P(h,C),i(!0)):l.size>0?(P(h,D),i(!0)):(P(h,C),i(!0))},[m,e,C,D,n]);const z=L({sharks:M,pointsData:C,allSharksVisible:a,onSharkSelect:s}),R=()=>{s(null),i(!0)},B=()=>{if(n){if(x(!1),u(0),j(null),p.current){const h=p.current.getGlobe();if(T(h),p.current.enableControls(),e){const I=G(e.id);P(h,I)}}}else if(x(!0),u(0),p.current&&e){p.current.disableControls();const h=p.current.getGlobe();T(h)}},J=o.useCallback((h,I)=>{u(h),j(I),p.current&&I&&p.current.showSinglePoint(I)},[]),H=()=>{l.size>0&&Array.from(r).every(h=>l.has(h))?d(new Set):d(new Set(r))},V=()=>{if(s(null),d(new Set),i(!0),n&&(x(!1),u(0),j(null),p.current&&p.current.enableControls()),w&&(N(!1),S(null),b(null)),p.current){const h=p.current.getGlobe();T(h)}c(h=>h==="individual"?"multiple":"individual")},F=()=>{w?(N(!1),S(null),b(null)):N(!0)};return t.jsx("div",{className:"page-content globeviews-wrapper",children:t.jsxs("div",{className:"globe-views-container",children:[t.jsxs("div",{className:"info-sidebar",children:[t.jsx("button",{className:`view-mode-toggle ${m}`,onClick:V,children:m==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),e&&t.jsxs("div",{className:"story-controls-container",children:[t.jsx(_,{shark:e,onToggleStepMode:B,isStepMode:n,showPauseForGeoLabs:!0}),t.jsx(ie,{shark:e,onStepChange:J,currentStepIndex:y,isVisible:n})]}),m==="multiple"&&t.jsx(ce,{globeRef:p,selectedSharksForLab:l,onToggleTimelineMode:F,isTimelineMode:w}),m==="multiple"?t.jsx("div",{className:"shark-info-panel",children:t.jsx(xe,{selectedSharksForLab:l,savedIds:r,sharks:M,onSelectAllToggle:H})}):t.jsx(ee,{shark:e})]}),t.jsxs("div",{className:"globe-container",children:[t.jsx(Z,{ref:p,onSharkClick:z,allowClicks:m==="individual"&&!e}),n&&g&&t.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lat.toFixed(3)}),","," ","Lng: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lng.toFixed(3)})," —"," ","Date: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.date||"N/A"})]})]}),t.jsx("div",{className:"shark-selector",children:t.jsx(te,{sharks:M,onSelect:z,onReset:R,selectedSharkId:e?e.id:null,DisplayComponent:h=>t.jsx(ue,{...h,viewMode:m,selectedSharksForLab:l,onLabSelectionChange:d,onSelect:m==="multiple"?null:h.onSelect}),disabled:n||w})})]})})}export{Ae as default};
