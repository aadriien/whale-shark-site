import{r as i,j as e,a as $,R as U,b as D,c as W,m as q}from"./index-DyYc_6yi.js";import{b as G,F as H,d as A,c as y,a as C,G as J}from"./FavoriteButton-B31GVcuJ.js";import{P as K}from"./PlayStoryButton-COzOguUK.js";import{S as O,a as Q}from"./SharkSelector-uASah4gZ.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";const X=({shark:t,onStepChange:r,currentStepIndex:g,isVisible:c})=>{const[l,S]=i.useState([]);if(i.useEffect(()=>{if(t){const a=G(t.id);S(a),c&&a.length===1&&r(0,a[0])}},[t,c,r]),!c||!t||l.length===0)return null;const h=a=>{const v=parseInt(a.target.value),x=l[v];r(v,x)},b=()=>{if(g>0){const a=g-1;r(a,l[a])}},d=()=>{if(g<l.length-1){const a=g+1;r(a,l[a])}},m=l[g];return e.jsx("div",{className:"story-step-container",children:e.jsxs("div",{className:"story-slider-section",children:[e.jsxs("h4",{children:["Point ",g+1," of ",l.length,m&&e.jsxs("span",{className:"step-date-header",children:[" ... ",m.date||"Unknown date"]})]}),e.jsxs("div",{className:"slider-controls",children:[e.jsx("button",{className:"step-button",onClick:b,disabled:g===0,children:"-"}),e.jsx("input",{type:"range",min:"0",max:l.length-1,value:g,onChange:h,className:"story-slider"}),e.jsx("button",{className:"step-button",onClick:d,disabled:g===l.length-1,children:"+"})]})]})})},Y=({shark:t})=>{const r=t.image!=="Unknown"?$(t.image):[];return e.jsxs("div",{className:"shark-banner",children:[e.jsx("div",{className:"tiny-banner-media",children:r.length>0?e.jsx("img",{src:r[0].url,alt:`Image of shark ${t.id}`}):e.jsx("span",{className:"no-image",children:"N/A"})}),e.jsxs("div",{className:"tiny-id-row",children:[e.jsx("strong",{children:t.id}),e.jsx(H,{sharkId:t.id})]})]})};function Z({sharks:t,onSelect:r,selectedSharkId:g,viewMode:c,selectedSharksForLab:l,onLabSelectionChange:S}){const[h,b]=i.useState(new Set),[d,m]=i.useState(!1);i.useEffect(()=>{const n=()=>{b(D()),m(!0)};return n(),window.addEventListener("storage",n),window.addEventListener("favoritesChanged",n),()=>{window.removeEventListener("storage",n),window.removeEventListener("favoritesChanged",n)}},[]);const a=i.useMemo(()=>{if(h.size===0)return[];const n=new Map(t.map(o=>[o.id,o]));return[...h].map(o=>n.get(o)).filter(Boolean).sort((o,j)=>o.id.localeCompare(j.id))},[t,h]),v=n=>{c==="multiple"?x(n.id):r&&r(n.id)},x=U.useCallback(n=>{if(S&&l){const o=new Set(l);o.has(n)?o.delete(n):o.add(n),S(o)}},[S,l]);return e.jsxs("div",{className:"saved-sharks-display",children:[e.jsx("div",{className:"saved-sharks-header",children:e.jsxs("h3",{children:["Saved Sharks (",a.length,")"]})}),a.length>0?e.jsx("div",{className:"scrollable-shark-list",children:e.jsx("div",{className:"saved-sharks-grid",children:a.map(n=>{const o=l&&l.has(n.id);return e.jsx("div",{className:`saved-shark-card-wrapper ${c==="individual"&&n.id===g?"selected":""} ${c==="multiple"&&o?"selected-for-lab":""}`,onClick:()=>v(n),children:e.jsx(Y,{shark:n})},n.id)})})}):d&&h.size===0?e.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",e.jsx("br",{}),e.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function ie(){const[t,r]=i.useState(null),[g,c]=i.useState(!0),[l,S]=i.useState(new Set),[h,b]=i.useState("multiple"),[d,m]=i.useState(new Set),[a,v]=i.useState(!1),[x,n]=i.useState(0),[o,j]=i.useState(null),u=i.useRef();i.useEffect(()=>{const s=()=>{S(D())};return s(),window.addEventListener("storage",s),window.addEventListener("favoritesChanged",s),()=>{window.removeEventListener("storage",s),window.removeEventListener("favoritesChanged",s)}},[]);const w=i.useMemo(()=>{const s=W();return console.log("Plotting saved sharks on globe:",s),A(s)},[l]),M=i.useMemo(()=>{if(d.size===0)return[];const s=Array.from(d);return console.log("Plotting selected lab sharks on globe:",s),A(s)},[d]),I=q;i.useEffect(()=>{if(!u.current)return;const s=u.current.getGlobe();if(y(s),a){c(!1);return}h==="individual"?t?(u.current.highlightShark(t.id,!0),c(!1)):(C(s,w),c(!0)):d.size>0?(C(s,M),c(!0)):(C(s,w),c(!0))},[h,t,w,M,a]);const P=s=>{if(typeof s=="object"&&s.lat!==void 0&&s.lng!==void 0){if(!g){console.log("Ignoring click because not all sharks are visible.");return}const{lat:f,lng:k}=s;console.log("Clicked at lat/lng:",f,k);const z=3,E=w.find(p=>{const N=Math.abs(p.lat-f),L=Math.abs(p.lng-k);return N<z&&L<z});if(E){const p=E.id.split("-")[0];console.log("Matched shark:",E.id," with ID: ",p);const N=I.find(L=>L.id==p)||null;console.log("Sending shark obect:",N),r(N)}else console.log("No nearby shark found."),r(null)}else{const f=I.find(k=>k.id==s)||null;r(f)}},F=()=>{r(null),c(!0)},R=()=>{if(a){if(v(!1),n(0),j(null),u.current){const s=u.current.getGlobe();if(y(s),u.current.enableControls(),t){const f=G(t.id);C(s,f)}}}else if(v(!0),n(0),u.current){const s=u.current.getGlobe();y(s)}},T=i.useCallback((s,f)=>{n(s),j(f),u.current&&f&&u.current.showSinglePoint(f)},[]),V=()=>{d.size>0&&Array.from(l).every(s=>d.has(s))?m(new Set):m(new Set(l))},B=()=>{if(r(null),m(new Set),c(!0),a&&(v(!1),n(0),j(null),u.current&&u.current.enableControls()),u.current){const s=u.current.getGlobe();y(s)}b(s=>s==="individual"?"multiple":"individual")};return e.jsx("div",{className:"page-content globeviews-wrapper",children:e.jsxs("div",{className:"globe-views-container",children:[e.jsxs("div",{className:"info-sidebar",children:[e.jsx("button",{className:`view-mode-toggle ${h}`,onClick:B,children:h==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),t&&e.jsxs("div",{className:"story-controls-container",children:[e.jsx(K,{shark:t,onToggleStepMode:R,isStepMode:a,showPauseForGeoLabs:!0}),e.jsx(X,{shark:t,onStepChange:T,currentStepIndex:x,isVisible:a})]}),h==="multiple"&&e.jsxs("div",{className:"multi-select-info",children:[e.jsxs("div",{className:"multi-select-header",children:[e.jsxs("h4",{children:["Selected for Lab (",d.size,"):"]}),e.jsxs("label",{className:"select-all-container",children:[e.jsx("input",{type:"checkbox",checked:d.size>0&&Array.from(l).every(s=>d.has(s)),onChange:V,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),e.jsx("div",{className:"selected-sharks-list",children:d.size>0?Array.from(d).join(", "):"None in lab"})]}),e.jsx(O,{shark:t})]}),e.jsxs("div",{className:"globe-container",children:[e.jsx(J,{ref:u,onSharkClick:P,allowClicks:h==="individual"&&!t}),a&&o&&e.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",e.jsx("span",{style:{fontWeight:"bold"},children:o.lat.toFixed(3)}),","," ","Lng: ",e.jsx("span",{style:{fontWeight:"bold"},children:o.lng.toFixed(3)})," —"," ","Date: ",e.jsx("span",{style:{fontWeight:"bold"},children:o.date||"N/A"})]})]}),e.jsx("div",{className:"shark-selector",children:e.jsx(Q,{sharks:I,onSelect:P,onReset:F,selectedSharkId:t?t.id:null,DisplayComponent:s=>e.jsx(Z,{...s,viewMode:h,selectedSharksForLab:d,onLabSelectionChange:m,onSelect:h==="multiple"?null:s.onSelect}),disabled:a})})]})})}export{ie as default};
