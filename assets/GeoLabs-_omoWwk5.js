import{r as l,j as t,M as z,c as V,a as O,b as ee,R as te,d as W,p as P,f as ne,m as F}from"./index-CwcZW0OQ.js";import{b as K,c as A,d as $,a as T,F as se,g as H,G as ae}from"./FavoriteButton-JI8XLnpW.js";import{P as re}from"./PlayStoryButton-Oh0j1F6R.js";import{u as ie,S as le,a as oe}from"./GlobeClick-Twq-dOzd.js";import{C as ce}from"./ChartPlaceholder-C1DRv8kc.js";import{D as de,H as ue,S as he}from"./SexLifeStageData-DuAaqmJQ.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";const me=({shark:e,onStepChange:a,currentStepIndex:s,isVisible:o})=>{const[r,f]=l.useState([]);if(l.useEffect(()=>{if(e){const n=K(e.id);f(n),o&&n.length===1&&a(0,n[0])}},[e,o,a]),!o||!e||r.length===0)return null;const h=n=>{const w=parseInt(n.target.value),g=r[w];a(w,g)},c=()=>{if(s>0){const n=s-1;a(n,r[n])}},i=()=>{if(s<r.length-1){const n=s+1;a(n,r[n])}},m=r[s];return t.jsx("div",{className:"story-step-container",children:t.jsxs("div",{className:"story-slider-section",children:[t.jsxs("h4",{children:["Point ",s+1," of ",r.length,m&&t.jsxs("span",{className:"step-date-header",children:[" ... ",m.date||"Unknown date"]})]}),t.jsxs("div",{className:"slider-controls",children:[t.jsx("button",{className:"step-button",onClick:c,disabled:s===0,children:"-"}),t.jsx("input",{type:"range",min:"0",max:r.length-1,value:s,onChange:h,className:"story-slider"}),t.jsx("button",{className:"step-button",onClick:i,disabled:s===r.length-1,children:"+"})]})]})})},fe=({onToggleTimelineMode:e,isTimelineMode:a=!1})=>t.jsx("div",{className:"timeline-mode-section",children:t.jsx("button",{className:`geo-labs-timeline-button
                    ${a?" timeline-mode-active":""}
                `,onClick:s=>{s.stopPropagation(),e()},children:a?"Exit Timeline Mode":t.jsxs(t.Fragment,{children:["Explore Shark Data ",t.jsx("strong",{children:"Timeline"})]})})}),ge=({onTimelineChange:e,currentMonth:a,currentYear:s,isVisible:o,availableSharks:r=[],plottedCoordinates:f=[]})=>{const h=()=>{const x=new Set;return V.forEach(S=>{(r.length===0||r.includes(S.whaleSharkID))&&S.coordinates.forEach(j=>{if(j.parsedDate){const C=new Date(j.parsedDate),M=C.getFullYear(),D=C.getMonth()+1;!isNaN(M)&&!isNaN(D)&&x.add(`${M}-${D.toString().padStart(2,"0")}`)}})}),Array.from(x).sort()},c=l.useMemo(()=>h(),[r]),i=()=>{if(c.length===0)return 0;const x=`${s||new Date().getFullYear()}-${(a||new Date().getMonth()+1).toString().padStart(2,"0")}`,S=c.indexOf(x);return S>=0?S:0},[m,n]=l.useState(i),g=(x=>{if(c.length===0)return{month:1,year:new Date().getFullYear()};const S=c[x]||c[0],[j,C]=S.split("-").map(Number);return{month:C,year:j}})(m),u=l.useMemo(()=>{if(!f||f.length===0)return[];const x=new Set;return f.forEach(S=>{if(S.id){const j=S.id.split("-")[0];x.add(j)}}),Array.from(x).sort((S,j)=>S.localeCompare(j))},[f]);if(l.useEffect(()=>{if(o&&c.length>0){const{month:x,year:S}=g;e(x,S)}},[m,o,e,c.length]),!o||c.length===0)return null;const v=x=>{const S=parseInt(x.target.value);n(S)},y=()=>{m>0&&n(m-1)},b=()=>{m<c.length-1&&n(m+1)},N=m>0,p=m<c.length-1;return t.jsxs("div",{className:"timeline-selector-container",children:[t.jsxs("div",{className:"timeline-navigation",children:[t.jsx("button",{className:"timeline-nav-button",onClick:y,disabled:!N,title:"Previous month",children:"←"}),t.jsxs("div",{className:"timeline-date-display",children:[z[g.month-1]," ",g.year]}),t.jsx("button",{className:"timeline-nav-button",onClick:b,disabled:!p,title:"Next month",children:"→"})]}),t.jsx("div",{className:"timeline-slider-section",children:t.jsx("input",{type:"range",min:"0",max:c.length-1,value:m,onChange:v,className:"timeline-slider"})}),t.jsxs("div",{className:"timeline-info",children:["Showing map data from ",z[g.month-1]," ",g.year]}),u.length>0&&t.jsxs("div",{className:"timeline-sharks-display",children:[t.jsxs("div",{className:"sharks-list-title",children:["Plotting ",u.length," whale shark",u.length!==1?"s":"",":"]}),t.jsx("div",{className:"selected-sharks-list",children:Array.from(u).join(", ")})]})]})},pe=({globeRef:e,selectedSharksForLab:a,onToggleTimelineMode:s,isTimelineMode:o,onTimelineStateChange:r})=>{const[f,h]=l.useState(null),[c,i]=l.useState(null),[m,n]=l.useState([]),w=()=>{o&&(h(null),i(null),n([])),s(),r==null||r(!1)},g=l.useCallback((v,y)=>{if(h(v),i(y),console.log(`Timeline changed to: ${v}/${y}`),e.current&&v&&y){const b=e.current.getGlobe();A(b);const N=O();let p;a.size>0?p=$(Array.from(a),v,y):p=$(N,v,y),n(p),T(b,p)}},[e,a]),u=()=>a.size>0?Array.from(a):O();return t.jsxs("div",{className:"timeline-controls-container",children:[t.jsx(fe,{onToggleTimelineMode:w,isTimelineMode:o}),t.jsx(ge,{onTimelineChange:g,currentMonth:f,currentYear:c,isVisible:o,availableSharks:u(),plottedCoordinates:m})]})},ve=({shark:e})=>{const a=e.image!=="Unknown"?ee(e.image):[];return t.jsxs("div",{className:"shark-banner",children:[t.jsx("div",{className:"tiny-banner-media",children:a.length>0?t.jsx("img",{src:a[0].url,alt:`Image of shark ${e.id}`}):t.jsx("span",{className:"no-image",children:"N/A"})}),t.jsxs("div",{className:"tiny-id-row",children:[t.jsx("strong",{children:e.id}),t.jsx(se,{sharkId:e.id})]})]})};function xe({sharks:e,onSelect:a,selectedSharkId:s,viewMode:o,selectedSharksForLab:r,onLabSelectionChange:f}){const[h,c]=l.useState(new Set),[i,m]=l.useState(!1);l.useEffect(()=>{const u=()=>{c(W()),m(!0)};return u(),window.addEventListener("storage",u),window.addEventListener("favoritesChanged",u),()=>{window.removeEventListener("storage",u),window.removeEventListener("favoritesChanged",u)}},[]);const n=l.useMemo(()=>{if(h.size===0)return[];const u=new Map(e.map(v=>[v.id,v]));return[...h].map(v=>u.get(v)).filter(Boolean).sort((v,y)=>v.id.localeCompare(y.id))},[e,h]),w=u=>{o==="multiple"?g(u.id):a&&a(u.id)},g=te.useCallback(u=>{if(f&&r){const v=new Set(r);v.has(u)?v.delete(u):v.add(u),f(v)}},[f,r]);return t.jsxs("div",{className:"saved-sharks-display",children:[t.jsx("div",{className:"saved-sharks-header",children:t.jsxs("h3",{children:["Saved Sharks (",n.length,")"]})}),n.length>0?t.jsx("div",{className:"scrollable-shark-list",children:t.jsx("div",{className:"saved-sharks-grid",children:n.map(u=>{const v=r&&r.has(u.id);return t.jsx("div",{className:`saved-shark-card-wrapper ${o==="individual"&&u.id===s?"selected":""} ${o==="multiple"&&v?"selected-for-lab":""}`,onClick:()=>w(u),children:t.jsx(ve,{shark:u})},u.id)})})}):i&&h.size===0?t.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",t.jsx("br",{}),t.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function Se(e){if(e.country)return e.country;if(e.countries){const a=e.countries.split(",")[0];return P(a)}return e["country (year)"]?P(e["country (year)"]):"Unknown"}function we(e){if(e.year)return e.year;if(e.newest)return new Date(e.newest).getFullYear();if(e["Newest Occurrence"])return new Date(e["Newest Occurrence"]).getFullYear();if(e.oldest)return new Date(e.oldest).getFullYear();if(e["Oldest Occurrence"])return new Date(e["Oldest Occurrence"]).getFullYear();if(e.countries){const a=ne(e.countries);if(a!=="Unknown"){const s=a.match(/(\d{4})/);if(s)return parseInt(s[1])}}return new Date().getFullYear()}function ye(e){if(e.publishing){const a=e.publishing.split(",")[0];return P(a)}return e["publishingCountry (year)"]?P(e["publishingCountry (year)"]):"Unknown"}function je(e,a){if(!e||e.length===0)return[];const s=Array.isArray(e)?e:Array.from(e);if(s.length>0&&(typeof s[0]=="string"||typeof s[0]=="number")){const o=new Set(s.map(r=>String(r)));return a.filter(r=>o.has(String(r.whaleSharkID))||o.has(String(r.identificationID))||o.has(String(r.id)))}return s}function be(e,a=[]){const s=je(e,a);if(s.length===0)return[{lab:"No sharks selected","Total Selected":0,"Total Occurrences":0,Countries:"N/A",Years:"N/A","Top 3 Publishing Countries":"N/A"}];const o=new Set,r=new Set,f=new Map;let h=0;s.forEach(n=>{o.add(Se(n)),r.add(we(n));const w=parseInt(n["Total Occurrences"])||parseInt(n.occurrences)||parseInt(n.TotalOccurrences)||1;h+=w;const g=ye(n);g!=="Unknown"&&f.set(g,(f.get(g)||0)+1)});const c=Array.from(f.entries()).sort((n,w)=>w[1]-n[1]).slice(0,3).map(([n])=>n).join(" > "),i=Array.from(r),m=Array.from(o);return[{lab:`${s.length} Selected Sharks`,"Total Selected":s.length,"Total Occurrences":h,Countries:m.slice(0,3).join(", ")+(m.length>3?"...":""),Years:i.length>0?`${Math.min(...i)} - ${Math.max(...i)}`:"N/A","Unique Countries":m.length,"Year Range":i.length>0?Math.max(...i)-Math.min(...i)+1:0,"Top 3 Publishing Countries":c||"Unknown"}]}function Ne(e,a=[]){if(!e||e.length===0)return[];const s=new Map;(Array.isArray(e)?e:Array.from(e)).forEach(f=>{const h=V.find(c=>c.whaleSharkID===f);h&&h.coordinates&&h.coordinates.forEach(c=>{if(c.eventDate){const i=new Date(c.eventDate);if(!isNaN(i.getTime())){const m=i.getFullYear(),n=z[i.getMonth()],w=`${m}-${n}`;s.set(w,(s.get(w)||0)+1)}}})});const r=[];for(const[f,h]of s.entries()){const[c,i]=f.split("-");r.push({year:parseInt(c),month:i,value:h})}return r}function Ce({selectedSharksForLab:e,savedIds:a,sharks:s,onSelectAllToggle:o}){const r=l.useMemo(()=>{if(e.size===0)return[];const c=Array.from(e),i=s.filter(m=>c.includes(m.id));return be(i)},[e,s]),f=l.useMemo(()=>e.size===0?[]:Ne(e),[e]),h=l.useMemo(()=>{if(e.size===0)return[];const c=Array.from(e);return s.filter(i=>c.includes(i.id))},[e,s]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"multi-select-info",children:[t.jsxs("div",{className:"multi-select-header",children:[t.jsxs("h4",{children:["Selected for Lab (",e.size,"):"]}),t.jsxs("label",{className:"select-all-container",children:[t.jsx("input",{type:"checkbox",checked:e.size>0&&Array.from(a).every(c=>e.has(c)),onChange:o,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),t.jsx("div",{className:"selected-sharks-list",children:e.size>0?Array.from(e).join(", "):"None in lab"})]}),t.jsx("div",{className:"overview-container",children:t.jsx(de,{dataset:r,filterField:"lab",selectedFilter:e.size>0?`${e.size} Selected Sharks`:"",displayFields:[{label:"Total Occurrences",field:"Total Occurrences"},{label:"Top 3 Publishing Countries",field:"Top 3 Publishing Countries"}]})}),t.jsx("div",{className:"heatmap-container",children:e.size>0&&f.length>0?t.jsx(ue,{data:f,title:"Lab Sharks Record Timeline"}):t.jsx(ce,{type:"heatmap",message:"Add sharks to lab for heatmap"})}),t.jsx("div",{className:"radial-heatmap-container",children:t.jsx(he,{sharks:h})})]})}function ze(){const[e,a]=l.useState(null),[s,o]=l.useState(!0),[r,f]=l.useState(F),[h,c]=l.useState(new Set),[i,m]=l.useState("multiple"),[n,w]=l.useState(new Set),[g,u]=l.useState(!1),[v,y]=l.useState(0),[b,N]=l.useState(null),p=l.useRef(),[x,S]=l.useState(!1),[j,C]=l.useState(null),[M,D]=l.useState(null),Y=F;l.useEffect(()=>{const d=()=>{c(W())};return d(),window.addEventListener("storage",d),window.addEventListener("favoritesChanged",d),()=>{window.removeEventListener("storage",d),window.removeEventListener("favoritesChanged",d)}},[]);const k=l.useMemo(()=>{const d=O(),I=r.map(E=>E.id),R=[...new Set(d)],B=[...new Set(I)];console.log("Unique sharks from saved IDs:",R),console.log("Unique sharks from filtered IDs:",B);const q=R.filter(E=>B.includes(E));return console.log("Plotting sharks on globe:",q),H(q)},[h,r]),G=l.useMemo(()=>{if(n.size===0)return[];const d=Array.from(n);return console.log("Plotting selected lab sharks on globe:",d),x&&j&&M?$(d,j,M):H(d)},[n,x,j,M]);l.useEffect(()=>{if(!p.current)return;const d=p.current.getGlobe();if(A(d),g){o(!1);return}if(x){o(!1);return}i==="individual"?e?(p.current.highlightShark(e.id,!0),o(!1)):(T(d,k),o(!0)):n.size>0?(T(d,G),o(!0)):(T(d,k),o(!0))},[i,e,k,G,g]);const U=ie({sharks:Y,pointsData:k,allSharksVisible:s,onSharkSelect:a}),J=()=>{a(null),o(!0)},Q=()=>{if(g){if(u(!1),y(0),N(null),p.current){const d=p.current.getGlobe();if(A(d),p.current.enableControls(),e){const I=K(e.id);T(d,I)}}}else if(u(!0),y(0),p.current&&e){p.current.disableControls();const d=p.current.getGlobe();A(d)}},X=l.useCallback((d,I)=>{y(d),N(I),p.current&&I&&p.current.showSinglePoint(I)},[]),Z=()=>{n.size>0&&Array.from(h).every(d=>n.has(d))?w(new Set):w(new Set(h))},_=()=>{if(a(null),w(new Set),o(!0),g&&(u(!1),y(0),N(null),p.current&&p.current.enableControls()),x&&(S(!1),C(null),D(null)),p.current){const d=p.current.getGlobe();A(d)}m(d=>d==="individual"?"multiple":"individual")},L=()=>{x?(S(!1),C(null),D(null)):S(!0)};return t.jsx("div",{className:"page-content globeviews-wrapper",children:t.jsxs("div",{className:"globe-views-container",children:[t.jsxs("div",{className:"info-sidebar",children:[t.jsx("button",{className:`view-mode-toggle ${i}`,onClick:_,children:i==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),e&&t.jsxs("div",{className:"story-controls-container",children:[t.jsx(re,{shark:e,onToggleStepMode:Q,isStepMode:g,showPauseForGeoLabs:!0}),t.jsx(me,{shark:e,onStepChange:X,currentStepIndex:v,isVisible:g})]}),i==="multiple"&&t.jsx(pe,{globeRef:p,selectedSharksForLab:n,onToggleTimelineMode:L,isTimelineMode:x}),i==="multiple"?t.jsx("div",{className:"shark-info-panel",children:t.jsx(Ce,{selectedSharksForLab:n,savedIds:h,sharks:Y,onSelectAllToggle:Z})}):t.jsx(le,{shark:e})]}),t.jsxs("div",{className:"globe-container",children:[t.jsx(ae,{ref:p,onSharkClick:U,allowClicks:i==="individual"&&!e}),g&&b&&t.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",t.jsx("span",{style:{fontWeight:"bold"},children:b.lat.toFixed(3)}),","," ","Lng: ",t.jsx("span",{style:{fontWeight:"bold"},children:b.lng.toFixed(3)})," —"," ","Date: ",t.jsx("span",{style:{fontWeight:"bold"},children:b.date||"N/A"})]})]}),t.jsx("div",{className:"shark-selector",children:t.jsx(oe,{sharks:Y,onSelect:U,onReset:J,selectedSharkId:e?e.id:null,DisplayComponent:d=>t.jsx(xe,{...d,viewMode:i,selectedSharksForLab:n,onLabSelectionChange:w,onSelect:i==="multiple"?null:d.onSelect}),disabled:g||x,onFilteredSharksChange:f})})]})})}export{ze as default};
