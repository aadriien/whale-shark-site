import{r as u,j as t,a as B,R as H,b as z,p as I,c as J,d as W,m as F}from"./index-CoFqSM2x.js";import{b as Y,F as L,d as q,e as O,c as A,a as D,G as K}from"./FavoriteButton-76vFVuwe.js";import{P as Q}from"./PlayStoryButton-DrdelJFx.js";import{S as X,a as Z}from"./SharkSelector-CFkRsXOo.js";import{D as _,H as ee,C as te,S as ne}from"./SexLifeStageData-DkH6ALFV.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";const se=({shark:e,onStepChange:i,currentStepIndex:a,isVisible:l})=>{const[r,m]=u.useState([]);if(u.useEffect(()=>{if(e){const s=Y(e.id);m(s),l&&s.length===1&&i(0,s[0])}},[e,l,i]),!l||!e||r.length===0)return null;const d=s=>{const v=parseInt(s.target.value),y=r[v];i(v,y)},f=()=>{if(a>0){const s=a-1;i(s,r[s])}},o=()=>{if(a<r.length-1){const s=a+1;i(s,r[s])}},h=r[a];return t.jsx("div",{className:"story-step-container",children:t.jsxs("div",{className:"story-slider-section",children:[t.jsxs("h4",{children:["Point ",a+1," of ",r.length,h&&t.jsxs("span",{className:"step-date-header",children:[" ... ",h.date||"Unknown date"]})]}),t.jsxs("div",{className:"slider-controls",children:[t.jsx("button",{className:"step-button",onClick:f,disabled:a===0,children:"-"}),t.jsx("input",{type:"range",min:"0",max:r.length-1,value:a,onChange:d,className:"story-slider"}),t.jsx("button",{className:"step-button",onClick:o,disabled:a===r.length-1,children:"+"})]})]})})},ae=({shark:e})=>{const i=e.image!=="Unknown"?B(e.image):[];return t.jsxs("div",{className:"shark-banner",children:[t.jsx("div",{className:"tiny-banner-media",children:i.length>0?t.jsx("img",{src:i[0].url,alt:`Image of shark ${e.id}`}):t.jsx("span",{className:"no-image",children:"N/A"})}),t.jsxs("div",{className:"tiny-id-row",children:[t.jsx("strong",{children:e.id}),t.jsx(L,{sharkId:e.id})]})]})};function re({sharks:e,onSelect:i,selectedSharkId:a,viewMode:l,selectedSharksForLab:r,onLabSelectionChange:m}){const[d,f]=u.useState(new Set),[o,h]=u.useState(!1);u.useEffect(()=>{const c=()=>{f(z()),h(!0)};return c(),window.addEventListener("storage",c),window.addEventListener("favoritesChanged",c),()=>{window.removeEventListener("storage",c),window.removeEventListener("favoritesChanged",c)}},[]);const s=u.useMemo(()=>{if(d.size===0)return[];const c=new Map(e.map(g=>[g.id,g]));return[...d].map(g=>c.get(g)).filter(Boolean).sort((g,w)=>g.id.localeCompare(w.id))},[e,d]),v=c=>{l==="multiple"?y(c.id):i&&i(c.id)},y=H.useCallback(c=>{if(m&&r){const g=new Set(r);g.has(c)?g.delete(c):g.add(c),m(g)}},[m,r]);return t.jsxs("div",{className:"saved-sharks-display",children:[t.jsx("div",{className:"saved-sharks-header",children:t.jsxs("h3",{children:["Saved Sharks (",s.length,")"]})}),s.length>0?t.jsx("div",{className:"scrollable-shark-list",children:t.jsx("div",{className:"saved-sharks-grid",children:s.map(c=>{const g=r&&r.has(c.id);return t.jsx("div",{className:`saved-shark-card-wrapper ${l==="individual"&&c.id===a?"selected":""} ${l==="multiple"&&g?"selected-for-lab":""}`,onClick:()=>v(c),children:t.jsx(ae,{shark:c})},c.id)})})}):o&&d.size===0?t.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",t.jsx("br",{}),t.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function ie(e){if(e.country)return e.country;if(e.countries){const i=e.countries.split(",")[0];return I(i)}return e["country (year)"]?I(e["country (year)"]):"Unknown"}function oe(e){if(e.year)return e.year;if(e.newest)return new Date(e.newest).getFullYear();if(e["Newest Occurrence"])return new Date(e["Newest Occurrence"]).getFullYear();if(e.oldest)return new Date(e.oldest).getFullYear();if(e["Oldest Occurrence"])return new Date(e["Oldest Occurrence"]).getFullYear();if(e.countries){const i=J(e.countries);if(i!=="Unknown"){const a=i.match(/(\d{4})/);if(a)return parseInt(a[1])}}return new Date().getFullYear()}function le(e){if(e.publishing){const i=e.publishing.split(",")[0];return I(i)}return e["publishingCountry (year)"]?I(e["publishingCountry (year)"]):"Unknown"}function ce(e,i){if(!e||e.length===0)return[];const a=Array.isArray(e)?e:Array.from(e);if(a.length>0&&(typeof a[0]=="string"||typeof a[0]=="number")){const l=new Set(a.map(r=>String(r)));return i.filter(r=>l.has(String(r.whaleSharkID))||l.has(String(r.identificationID))||l.has(String(r.id)))}return a}function de(e,i=[]){const a=ce(e,i);if(a.length===0)return[{Summary:"No sharks selected","Total Selected":0,"Total Occurrences":0,Countries:"N/A",Years:"N/A","Top 3 Publishing Countries":"N/A"}];const l=new Set,r=new Set,m=new Map;let d=0;a.forEach(s=>{l.add(ie(s)),r.add(oe(s));const v=parseInt(s["Total Occurrences"])||parseInt(s.occurrences)||parseInt(s.TotalOccurrences)||1;d+=v;const y=le(s);y!=="Unknown"&&m.set(y,(m.get(y)||0)+1)});const f=Array.from(m.entries()).sort((s,v)=>v[1]-s[1]).slice(0,3).map(([s])=>s).join(" > "),o=Array.from(r),h=Array.from(l);return[{Summary:`${a.length} Selected Sharks`,"Total Selected":a.length,"Total Occurrences":d,Countries:h.slice(0,3).join(", ")+(h.length>3?"...":""),Years:o.length>0?`${Math.min(...o)} - ${Math.max(...o)}`:"N/A","Unique Countries":h.length,"Year Range":o.length>0?Math.max(...o)-Math.min(...o)+1:0,"Top 3 Publishing Countries":f||"Unknown"}]}function ue(e,i=[]){if(!e||e.length===0)return[];const a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=new Map;(Array.isArray(e)?e:Array.from(e)).forEach(d=>{const f=q.find(o=>o.whaleSharkID===d);f&&f.coordinates&&f.coordinates.forEach(o=>{if(o.eventDate){const h=new Date(o.eventDate);if(!isNaN(h.getTime())){const s=h.getFullYear(),v=a[h.getMonth()],y=`${s}-${v}`;l.set(y,(l.get(y)||0)+1)}}})});const m=[];for(const[d,f]of l.entries()){const[o,h]=d.split("-");m.push({year:parseInt(o),month:h,value:f})}return m}function he({selectedSharksForLab:e,savedIds:i,sharks:a,onSelectAllToggle:l}){const r=u.useMemo(()=>{if(e.size===0)return[];const f=Array.from(e),o=a.filter(h=>f.includes(h.id));return de(o)},[e,a]),m=u.useMemo(()=>e.size===0?[]:ue(e),[e]),d=u.useMemo(()=>{if(e.size===0)return[];const f=Array.from(e);return a.filter(o=>f.includes(o.id))},[e,a]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"multi-select-info",children:[t.jsxs("div",{className:"multi-select-header",children:[t.jsxs("h4",{children:["Selected for Lab (",e.size,"):"]}),t.jsxs("label",{className:"select-all-container",children:[t.jsx("input",{type:"checkbox",checked:e.size>0&&Array.from(i).every(f=>e.has(f)),onChange:l,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),t.jsx("div",{className:"selected-sharks-list",children:e.size>0?Array.from(e).join(", "):"None in lab"})]}),t.jsx("div",{className:"overview-container",children:t.jsx(_,{dataset:r,filterField:"Summary",selectedFilter:e.size>0?`${e.size} Selected Sharks`:"",displayFields:[{label:"Total Occurrences",field:"Total Occurrences"},{label:"Top 3 Publishing Countries",field:"Top 3 Publishing Countries"}]})}),t.jsx("div",{className:"heatmap-container",children:e.size>0&&m.length>0?t.jsx(ee,{data:m,title:"Lab Sharks Occurrence Timeline"}):t.jsx(te,{type:"heatmap",message:"Add sharks to lab for heatmap"})}),t.jsx("div",{className:"radial-heatmap-container",children:t.jsx(ne,{sharks:d})})]})}function xe(){const[e,i]=u.useState(null),[a,l]=u.useState(!0),[r,m]=u.useState(new Set),[d,f]=u.useState("multiple"),[o,h]=u.useState(new Set),[s,v]=u.useState(!1),[y,c]=u.useState(0),[g,w]=u.useState(null),p=u.useRef();u.useEffect(()=>{const n=()=>{m(z())};return n(),window.addEventListener("storage",n),window.addEventListener("favoritesChanged",n),()=>{window.removeEventListener("storage",n),window.removeEventListener("favoritesChanged",n)}},[]);const b=u.useMemo(()=>{const n=W();return console.log("Plotting saved sharks on globe:",n),O(n)},[r]),k=u.useMemo(()=>{if(o.size===0)return[];const n=Array.from(o);return console.log("Plotting selected lab sharks on globe:",n),O(n)},[o]),j=F;u.useEffect(()=>{if(!p.current)return;const n=p.current.getGlobe();if(A(n),s){l(!1);return}d==="individual"?e?(p.current.highlightShark(e.id,!0),l(!1)):(D(n,b),l(!0)):o.size>0?(D(n,k),l(!0)):(D(n,b),l(!0))},[d,e,b,k,s]);const T=n=>{if(typeof n=="object"&&n.lat!==void 0&&n.lng!==void 0){if(!a){console.log("Ignoring click because not all sharks are visible.");return}const{lat:S,lng:N}=n;console.log("Clicked at lat/lng:",S,N);const E=3,M=b.find(x=>{const C=Math.abs(x.lat-S),P=Math.abs(x.lng-N);return C<E&&P<E});if(M){const x=M.id.split("-")[0];console.log("Matched shark:",M.id," with ID: ",x);const C=j.find(P=>P.id==x)||null;console.log("Sending shark obect:",C),i(C)}else console.log("No nearby shark found."),i(null)}else{const S=j.find(N=>N.id==n)||null;i(S)}},$=()=>{i(null),l(!0)},G=()=>{if(s){if(v(!1),c(0),w(null),p.current){const n=p.current.getGlobe();if(A(n),p.current.enableControls(),e){const S=Y(e.id);D(n,S)}}}else if(v(!0),c(0),p.current){const n=p.current.getGlobe();A(n)}},R=u.useCallback((n,S)=>{c(n),w(S),p.current&&S&&p.current.showSinglePoint(S)},[]),U=()=>{o.size>0&&Array.from(r).every(n=>o.has(n))?h(new Set):h(new Set(r))},V=()=>{if(i(null),h(new Set),l(!0),s&&(v(!1),c(0),w(null),p.current&&p.current.enableControls()),p.current){const n=p.current.getGlobe();A(n)}f(n=>n==="individual"?"multiple":"individual")};return t.jsx("div",{className:"page-content globeviews-wrapper",children:t.jsxs("div",{className:"globe-views-container",children:[t.jsxs("div",{className:"info-sidebar",children:[t.jsx("button",{className:`view-mode-toggle ${d}`,onClick:V,children:d==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),e&&t.jsxs("div",{className:"story-controls-container",children:[t.jsx(Q,{shark:e,onToggleStepMode:G,isStepMode:s,showPauseForGeoLabs:!0}),t.jsx(se,{shark:e,onStepChange:R,currentStepIndex:y,isVisible:s})]}),d==="multiple"?t.jsx("div",{className:"shark-info-panel",children:t.jsx(he,{selectedSharksForLab:o,savedIds:r,sharks:j,onSelectAllToggle:U})}):t.jsx(X,{shark:e})]}),t.jsxs("div",{className:"globe-container",children:[t.jsx(K,{ref:p,onSharkClick:T,allowClicks:d==="individual"&&!e}),s&&g&&t.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lat.toFixed(3)}),","," ","Lng: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lng.toFixed(3)})," —"," ","Date: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.date||"N/A"})]})]}),t.jsx("div",{className:"shark-selector",children:t.jsx(Z,{sharks:j,onSelect:T,onReset:$,selectedSharkId:e?e.id:null,DisplayComponent:n=>t.jsx(re,{...n,viewMode:d,selectedSharksForLab:o,onLabSelectionChange:h,onSelect:d==="multiple"?null:n.onSelect}),disabled:s})})]})})}export{xe as default};
