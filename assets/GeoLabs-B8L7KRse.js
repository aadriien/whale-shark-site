import{r as c,j as t,a as G,b as _,R as L,c as H,p as U,d as ee,m as te}from"./index-CIoHcLen.js";import{b as V,d as F,c as T,e as z,a as k,F as ne,f as J,G as se}from"./FavoriteButton-DfIzzq7j.js";import{P as ae}from"./PlayStoryButton-CIanB2pT.js";import{S as re,a as le}from"./SharkSelector-DKTyGZGi.js";import{D as ie,H as oe,C as ce,S as de}from"./SexLifeStageData-Dvnj_ZB5.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";const ue=({shark:e,onStepChange:a,currentStepIndex:r,isVisible:o})=>{const[l,f]=c.useState([]);if(c.useEffect(()=>{if(e){const s=V(e.id);f(s),o&&s.length===1&&a(0,s[0])}},[e,o,a]),!o||!e||l.length===0)return null;const m=s=>{const S=parseInt(s.target.value),j=l[S];a(S,j)},d=()=>{if(r>0){const s=r-1;a(s,l[s])}},i=()=>{if(r<l.length-1){const s=r+1;a(s,l[s])}},u=l[r];return t.jsx("div",{className:"story-step-container",children:t.jsxs("div",{className:"story-slider-section",children:[t.jsxs("h4",{children:["Point ",r+1," of ",l.length,u&&t.jsxs("span",{className:"step-date-header",children:[" ... ",u.date||"Unknown date"]})]}),t.jsxs("div",{className:"slider-controls",children:[t.jsx("button",{className:"step-button",onClick:d,disabled:r===0,children:"-"}),t.jsx("input",{type:"range",min:"0",max:l.length-1,value:r,onChange:m,className:"story-slider"}),t.jsx("button",{className:"step-button",onClick:i,disabled:r===l.length-1,children:"+"})]})]})})},he=({onToggleTimelineMode:e,isTimelineMode:a=!1})=>t.jsx("div",{className:"timeline-mode-section",children:t.jsx("button",{className:`geo-labs-timeline-button
                    ${a?" timeline-mode-active":""}
                `,onClick:r=>{r.stopPropagation(),e()},children:a?"Exit Timeline Mode":t.jsxs(t.Fragment,{children:["Explore Shark Data ",t.jsx("strong",{children:"Timeline"})]})})}),me=({onTimelineChange:e,currentMonth:a,currentYear:r,isVisible:o,availableSharks:l=[],plottedCoordinates:f=[]})=>{const m=()=>{const v=new Set;return F.forEach(x=>{(l.length===0||l.includes(x.whaleSharkID))&&x.coordinates.forEach(b=>{if(b.parsedDate){const M=new Date(b.parsedDate),Y=M.getFullYear(),A=M.getMonth()+1;!isNaN(Y)&&!isNaN(A)&&v.add(`${Y}-${A.toString().padStart(2,"0")}`)}})}),Array.from(v).sort()},d=c.useMemo(()=>m(),[l]),i=()=>{if(d.length===0)return 0;const v=`${r||new Date().getFullYear()}-${(a||new Date().getMonth()+1).toString().padStart(2,"0")}`,x=d.indexOf(v);return x>=0?x:0},[u,s]=c.useState(i),S=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=(v=>{if(d.length===0)return{month:1,year:new Date().getFullYear()};const x=d[v]||d[0],[b,M]=x.split("-").map(Number);return{month:M,year:b}})(u),g=c.useMemo(()=>{if(!f||f.length===0)return[];const v=new Set;return f.forEach(x=>{if(x.id){const b=x.id.split("-")[0];v.add(b)}}),Array.from(v).sort((x,b)=>x.localeCompare(b))},[f]);if(c.useEffect(()=>{if(o&&d.length>0){const{month:v,year:x}=h;e(v,x)}},[u,o,e,d.length]),!o||d.length===0)return null;const w=v=>{const x=parseInt(v.target.value);s(x)},p=()=>{u>0&&s(u-1)},N=()=>{u<d.length-1&&s(u+1)},C=u>0,P=u<d.length-1;return t.jsx("div",{className:"timeline-selector-container",children:t.jsxs("div",{className:"timeline-controls",children:[t.jsxs("div",{className:"timeline-navigation",children:[t.jsx("button",{className:"timeline-nav-button",onClick:p,disabled:!C,title:"Previous month",children:"←"}),t.jsxs("div",{className:"timeline-date-display",children:[S[h.month-1]," ",h.year]}),t.jsx("button",{className:"timeline-nav-button",onClick:N,disabled:!P,title:"Next month",children:"→"})]}),t.jsx("div",{className:"timeline-slider-section",children:t.jsx("input",{type:"range",min:"0",max:d.length-1,value:u,onChange:w,className:"timeline-slider"})}),t.jsxs("div",{className:"timeline-info",children:["Showing map data from ",S[h.month-1]," ",h.year]}),g.length>0&&t.jsxs("div",{className:"timeline-sharks-display",children:[t.jsxs("div",{className:"sharks-list-title",children:["Plotting ",g.length," whale shark",g.length!==1?"s":"",":"]}),t.jsx("div",{className:"sharks-list",children:g.map(v=>t.jsx("span",{className:"timeline-shark-id",children:v},v))})]})]})})},ge=({globeRef:e,selectedSharksForLab:a,onToggleTimelineMode:r,isTimelineMode:o,onTimelineStateChange:l})=>{const[f,m]=c.useState(null),[d,i]=c.useState(null),[u,s]=c.useState([]),S=()=>{o&&(m(null),i(null),s([])),r(),l==null||l(!1)},j=c.useCallback((g,w)=>{if(m(g),i(w),console.log(`Timeline changed to: ${g}/${w}`),e.current&&g&&w){const p=e.current.getGlobe();T(p);const N=G();let C;a.size>0?C=z(Array.from(a),g,w):C=z(N,g,w),s(C),k(p,C)}},[e,a]),h=()=>a.size>0?Array.from(a):G();return t.jsxs("div",{className:"timeline-controls-container",children:[t.jsx(he,{onToggleTimelineMode:S,isTimelineMode:o}),t.jsx(me,{onTimelineChange:j,currentMonth:f,currentYear:d,isVisible:o,availableSharks:h(),plottedCoordinates:u})]})},fe=({shark:e})=>{const a=e.image!=="Unknown"?_(e.image):[];return t.jsxs("div",{className:"shark-banner",children:[t.jsx("div",{className:"tiny-banner-media",children:a.length>0?t.jsx("img",{src:a[0].url,alt:`Image of shark ${e.id}`}):t.jsx("span",{className:"no-image",children:"N/A"})}),t.jsxs("div",{className:"tiny-id-row",children:[t.jsx("strong",{children:e.id}),t.jsx(ne,{sharkId:e.id})]})]})};function pe({sharks:e,onSelect:a,selectedSharkId:r,viewMode:o,selectedSharksForLab:l,onLabSelectionChange:f}){const[m,d]=c.useState(new Set),[i,u]=c.useState(!1);c.useEffect(()=>{const h=()=>{d(H()),u(!0)};return h(),window.addEventListener("storage",h),window.addEventListener("favoritesChanged",h),()=>{window.removeEventListener("storage",h),window.removeEventListener("favoritesChanged",h)}},[]);const s=c.useMemo(()=>{if(m.size===0)return[];const h=new Map(e.map(g=>[g.id,g]));return[...m].map(g=>h.get(g)).filter(Boolean).sort((g,w)=>g.id.localeCompare(w.id))},[e,m]),S=h=>{o==="multiple"?j(h.id):a&&a(h.id)},j=L.useCallback(h=>{if(f&&l){const g=new Set(l);g.has(h)?g.delete(h):g.add(h),f(g)}},[f,l]);return t.jsxs("div",{className:"saved-sharks-display",children:[t.jsx("div",{className:"saved-sharks-header",children:t.jsxs("h3",{children:["Saved Sharks (",s.length,")"]})}),s.length>0?t.jsx("div",{className:"scrollable-shark-list",children:t.jsx("div",{className:"saved-sharks-grid",children:s.map(h=>{const g=l&&l.has(h.id);return t.jsx("div",{className:`saved-shark-card-wrapper ${o==="individual"&&h.id===r?"selected":""} ${o==="multiple"&&g?"selected-for-lab":""}`,onClick:()=>S(h),children:t.jsx(fe,{shark:h})},h.id)})})}):i&&m.size===0?t.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",t.jsx("br",{}),t.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function ve(e){if(e.country)return e.country;if(e.countries){const a=e.countries.split(",")[0];return U(a)}return e["country (year)"]?U(e["country (year)"]):"Unknown"}function xe(e){if(e.year)return e.year;if(e.newest)return new Date(e.newest).getFullYear();if(e["Newest Occurrence"])return new Date(e["Newest Occurrence"]).getFullYear();if(e.oldest)return new Date(e.oldest).getFullYear();if(e["Oldest Occurrence"])return new Date(e["Oldest Occurrence"]).getFullYear();if(e.countries){const a=ee(e.countries);if(a!=="Unknown"){const r=a.match(/(\d{4})/);if(r)return parseInt(r[1])}}return new Date().getFullYear()}function Se(e){if(e.publishing){const a=e.publishing.split(",")[0];return U(a)}return e["publishingCountry (year)"]?U(e["publishingCountry (year)"]):"Unknown"}function ye(e,a){if(!e||e.length===0)return[];const r=Array.isArray(e)?e:Array.from(e);if(r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number")){const o=new Set(r.map(l=>String(l)));return a.filter(l=>o.has(String(l.whaleSharkID))||o.has(String(l.identificationID))||o.has(String(l.id)))}return r}function je(e,a=[]){const r=ye(e,a);if(r.length===0)return[{Summary:"No sharks selected","Total Selected":0,"Total Occurrences":0,Countries:"N/A",Years:"N/A","Top 3 Publishing Countries":"N/A"}];const o=new Set,l=new Set,f=new Map;let m=0;r.forEach(s=>{o.add(ve(s)),l.add(xe(s));const S=parseInt(s["Total Occurrences"])||parseInt(s.occurrences)||parseInt(s.TotalOccurrences)||1;m+=S;const j=Se(s);j!=="Unknown"&&f.set(j,(f.get(j)||0)+1)});const d=Array.from(f.entries()).sort((s,S)=>S[1]-s[1]).slice(0,3).map(([s])=>s).join(" > "),i=Array.from(l),u=Array.from(o);return[{Summary:`${r.length} Selected Sharks`,"Total Selected":r.length,"Total Occurrences":m,Countries:u.slice(0,3).join(", ")+(u.length>3?"...":""),Years:i.length>0?`${Math.min(...i)} - ${Math.max(...i)}`:"N/A","Unique Countries":u.length,"Year Range":i.length>0?Math.max(...i)-Math.min(...i)+1:0,"Top 3 Publishing Countries":d||"Unknown"}]}function we(e,a=[]){if(!e||e.length===0)return[];const r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=new Map;(Array.isArray(e)?e:Array.from(e)).forEach(m=>{const d=F.find(i=>i.whaleSharkID===m);d&&d.coordinates&&d.coordinates.forEach(i=>{if(i.eventDate){const u=new Date(i.eventDate);if(!isNaN(u.getTime())){const s=u.getFullYear(),S=r[u.getMonth()],j=`${s}-${S}`;o.set(j,(o.get(j)||0)+1)}}})});const f=[];for(const[m,d]of o.entries()){const[i,u]=m.split("-");f.push({year:parseInt(i),month:u,value:d})}return f}function be({selectedSharksForLab:e,savedIds:a,sharks:r,onSelectAllToggle:o}){const l=c.useMemo(()=>{if(e.size===0)return[];const d=Array.from(e),i=r.filter(u=>d.includes(u.id));return je(i)},[e,r]),f=c.useMemo(()=>e.size===0?[]:we(e),[e]),m=c.useMemo(()=>{if(e.size===0)return[];const d=Array.from(e);return r.filter(i=>d.includes(i.id))},[e,r]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"multi-select-info",children:[t.jsxs("div",{className:"multi-select-header",children:[t.jsxs("h4",{children:["Selected for Lab (",e.size,"):"]}),t.jsxs("label",{className:"select-all-container",children:[t.jsx("input",{type:"checkbox",checked:e.size>0&&Array.from(a).every(d=>e.has(d)),onChange:o,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),t.jsx("div",{className:"selected-sharks-list",children:e.size>0?Array.from(e).join(", "):"None in lab"})]}),t.jsx("div",{className:"overview-container",children:t.jsx(ie,{dataset:l,filterField:"Summary",selectedFilter:e.size>0?`${e.size} Selected Sharks`:"",displayFields:[{label:"Total Occurrences",field:"Total Occurrences"},{label:"Top 3 Publishing Countries",field:"Top 3 Publishing Countries"}]})}),t.jsx("div",{className:"heatmap-container",children:e.size>0&&f.length>0?t.jsx(oe,{data:f,title:"Lab Sharks Occurrence Timeline"}):t.jsx(ce,{type:"heatmap",message:"Add sharks to lab for heatmap"})}),t.jsx("div",{className:"radial-heatmap-container",children:t.jsx(de,{sharks:m})})]})}function Pe(){const[e,a]=c.useState(null),[r,o]=c.useState(!0),[l,f]=c.useState(new Set),[m,d]=c.useState("multiple"),[i,u]=c.useState(new Set),[s,S]=c.useState(!1),[j,h]=c.useState(0),[g,w]=c.useState(null),p=c.useRef(),[N,C]=c.useState(!1),[P,v]=c.useState(null),[x,b]=c.useState(null);c.useEffect(()=>{const n=()=>{f(H())};return n(),window.addEventListener("storage",n),window.addEventListener("favoritesChanged",n),()=>{window.removeEventListener("storage",n),window.removeEventListener("favoritesChanged",n)}},[]);const M=c.useMemo(()=>{const n=G();return console.log("Plotting saved sharks on globe:",n),J(n)},[l]),Y=c.useMemo(()=>{if(i.size===0)return[];const n=Array.from(i);return console.log("Plotting selected lab sharks on globe:",n),N&&P&&x?z(n,P,x):J(n)},[i,N,P,x]),A=te;c.useEffect(()=>{if(!p.current)return;const n=p.current.getGlobe();if(T(n),s){o(!1);return}if(N){o(!1);return}m==="individual"?e?(p.current.highlightShark(e.id,!0),o(!1)):(k(n,M),o(!0)):i.size>0?(k(n,Y),o(!0)):(k(n,M),o(!0))},[m,e,M,Y,s]);const B=n=>{if(typeof n=="object"&&n.lat!==void 0&&n.lng!==void 0){if(!r){console.log("Ignoring click because not all sharks are visible.");return}const{lat:y,lng:I}=n;console.log("Clicked at lat/lng:",y,I);const O=3,D=M.find(E=>{const $=Math.abs(E.lat-y),R=Math.abs(E.lng-I);return $<O&&R<O});if(D){const E=D.id.split("-")[0];console.log("Matched shark:",D.id," with ID: ",E);const $=A.find(R=>R.id==E)||null;console.log("Sending shark obect:",$),a($)}else console.log("No nearby shark found."),a(null)}else{const y=A.find(I=>I.id==n)||null;a(y)}},W=()=>{a(null),o(!0)},q=()=>{if(s){if(S(!1),h(0),w(null),p.current){const n=p.current.getGlobe();if(T(n),p.current.enableControls(),e){const y=V(e.id);k(n,y)}}}else if(S(!0),h(0),p.current){const n=p.current.getGlobe();T(n)}},K=c.useCallback((n,y)=>{h(n),w(y),p.current&&y&&p.current.showSinglePoint(y)},[]),Q=()=>{i.size>0&&Array.from(l).every(n=>i.has(n))?u(new Set):u(new Set(l))},X=()=>{if(a(null),u(new Set),o(!0),s&&(S(!1),h(0),w(null),p.current&&p.current.enableControls()),N&&(C(!1),v(null),b(null)),p.current){const n=p.current.getGlobe();T(n)}d(n=>n==="individual"?"multiple":"individual")},Z=()=>{N?(C(!1),v(null),b(null)):C(!0)};return c.useCallback((n,y)=>{if(v(n),b(y),console.log(`Timeline changed to: ${n}/${y}`),p.current&&n&&y){const I=p.current.getGlobe();T(I);const O=G();let D;i.size>0?D=z(Array.from(i),n,y):D=z(O,n,y),k(I,D)}},[i]),t.jsx("div",{className:"page-content globeviews-wrapper",children:t.jsxs("div",{className:"globe-views-container",children:[t.jsxs("div",{className:"info-sidebar",children:[t.jsx("button",{className:`view-mode-toggle ${m}`,onClick:X,children:m==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),e&&t.jsxs("div",{className:"story-controls-container",children:[t.jsx(ae,{shark:e,onToggleStepMode:q,isStepMode:s,showPauseForGeoLabs:!0}),t.jsx(ue,{shark:e,onStepChange:K,currentStepIndex:j,isVisible:s})]}),m==="multiple"&&t.jsx(ge,{globeRef:p,selectedSharksForLab:i,onToggleTimelineMode:Z,isTimelineMode:N}),m==="multiple"?t.jsx("div",{className:"shark-info-panel",children:t.jsx(be,{selectedSharksForLab:i,savedIds:l,sharks:A,onSelectAllToggle:Q})}):t.jsx(re,{shark:e})]}),t.jsxs("div",{className:"globe-container",children:[t.jsx(se,{ref:p,onSharkClick:B,allowClicks:m==="individual"&&!e}),s&&g&&t.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lat.toFixed(3)}),","," ","Lng: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.lng.toFixed(3)})," —"," ","Date: ",t.jsx("span",{style:{fontWeight:"bold"},children:g.date||"N/A"})]})]}),t.jsx("div",{className:"shark-selector",children:t.jsx(le,{sharks:A,onSelect:B,onReset:W,selectedSharkId:e?e.id:null,DisplayComponent:n=>t.jsx(pe,{...n,viewMode:m,selectedSharksForLab:i,onLabSelectionChange:u,onSelect:m==="multiple"?null:n.onSelect}),disabled:s||N})})]})})}export{Pe as default};
