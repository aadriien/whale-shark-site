import{r as i,j as e,M as Y,c as O,a as z,b as ee,d as V,p as W,f as te,m as q}from"./index-CszvLcAE.js";import{b as K,c as D,d as $,a as A,F as ne,g as H,G as se}from"./FavoriteButton-SD0rYglH.js";import{P as ae}from"./PlayStoryButton-DXrDM9Qu.js";import{u as ie,S as re,a as le}from"./GlobeClick-Dz34qazm.js";import{C as oe}from"./ChartPlaceholder-DsOQoCZ7.js";import{D as ce,H as de,S as ue}from"./SexLifeStageData-Cww7ZyUb.js";import"./three.module-BTTigmqi.js";import"./linear-BcwBMSNj.js";import"./OrbitControls-C22u-Lz6.js";import"./FilterSharks-DNa0WsgC.js";const he=({shark:t,onStepChange:n,currentStepIndex:u,isVisible:r})=>{const[a,m]=i.useState([]);if(i.useEffect(()=>{if(t){const s=K(t.id);m(s),r&&s.length===1&&n(0,s[0])}},[t,r,n]),!r||!t||a.length===0)return null;const l=s=>{const j=parseInt(s.target.value),p=a[j];n(j,p)},o=()=>{if(u>0){const s=u-1;n(s,a[s])}},h=()=>{if(u<a.length-1){const s=u+1;n(s,a[s])}},g=a[u];return e.jsx("div",{className:"story-step-container",children:e.jsxs("div",{className:"story-slider-section",children:[e.jsxs("h4",{children:["Point ",u+1," of ",a.length,g&&e.jsxs("span",{className:"step-date-header",children:[" ... ",g.date||"Unknown date"]})]}),e.jsxs("div",{className:"slider-controls",children:[e.jsx("button",{className:"step-button",onClick:o,disabled:u===0,children:"-"}),e.jsx("input",{type:"range",min:"0",max:a.length-1,value:u,onChange:l,className:"story-slider"}),e.jsx("button",{className:"step-button",onClick:h,disabled:u===a.length-1,children:"+"})]})]})})},me=({onToggleTimelineMode:t,isTimelineMode:n=!1})=>e.jsx("div",{className:"timeline-mode-section",children:e.jsx("button",{className:`geo-labs-timeline-button
                    ${n?" timeline-mode-active":""}
                `,onClick:u=>{u.stopPropagation(),t()},children:n?"Exit Timeline Mode":e.jsxs(e.Fragment,{children:["Explore Shark Data ",e.jsx("strong",{children:"Timeline"})]})})}),ge=({onTimelineChange:t,currentMonth:n,currentYear:u,isVisible:r,availableSharks:a=[],plottedCoordinates:m=[]})=>{const l=()=>{const x=new Set;return O.forEach(S=>{(a.length===0||a.includes(S.whaleSharkID))&&S.coordinates.forEach(b=>{if(b.parsedDate){const k=new Date(b.parsedDate),M=k.getFullYear(),I=k.getMonth()+1;!isNaN(M)&&!isNaN(I)&&x.add(`${M}-${I.toString().padStart(2,"0")}`)}})}),Array.from(x).sort()},o=i.useMemo(()=>l(),[a]),h=()=>{if(o.length===0)return 0;const x=`${u||new Date().getFullYear()}-${(n||new Date().getMonth()+1).toString().padStart(2,"0")}`,S=o.indexOf(x);return S>=0?S:0},[g,s]=i.useState(h),p=(x=>{if(o.length===0)return{month:1,year:new Date().getFullYear()};const S=o[x]||o[0],[b,k]=S.split("-").map(Number);return{month:k,year:b}})(g),d=i.useMemo(()=>{if(!m||m.length===0)return[];const x=new Set;return m.forEach(S=>{if(S.id){const b=S.id.split("-")[0];x.add(b)}}),Array.from(x).sort((S,b)=>S.localeCompare(b))},[m]);if(i.useEffect(()=>{if(r&&o.length>0){const{month:x,year:S}=p;t(x,S)}},[g,r,t,o.length]),!r||o.length===0)return null;const v=x=>{const S=parseInt(x.target.value);s(S)},w=()=>{g>0&&s(g-1)},N=()=>{g<o.length-1&&s(g+1)},y=g>0,f=g<o.length-1;return e.jsxs("div",{className:"timeline-selector-container",children:[e.jsxs("div",{className:"timeline-navigation",children:[e.jsx("button",{className:"timeline-nav-button",onClick:w,disabled:!y,title:"Previous month",children:"←"}),e.jsxs("div",{className:"timeline-date-display",children:[Y[p.month-1]," ",p.year]}),e.jsx("button",{className:"timeline-nav-button",onClick:N,disabled:!f,title:"Next month",children:"→"})]}),e.jsx("div",{className:"timeline-slider-section",children:e.jsx("input",{type:"range",min:"0",max:o.length-1,value:g,onChange:v,className:"timeline-slider"})}),e.jsxs("div",{className:"timeline-info",children:["Showing map data from ",Y[p.month-1]," ",p.year]}),d.length>0&&e.jsxs("div",{className:"timeline-sharks-display",children:[e.jsxs("div",{className:"sharks-list-title",children:["Plotting ",d.length," whale shark",d.length!==1?"s":"",":"]}),e.jsx("div",{className:"selected-sharks-list",children:Array.from(d).join(", ")})]})]})},fe=({globeRef:t,selectedSharksForLab:n,onToggleTimelineMode:u,isTimelineMode:r,onTimelineStateChange:a})=>{const[m,l]=i.useState(null),[o,h]=i.useState(null),[g,s]=i.useState([]),j=()=>{r&&(l(null),h(null),s([])),u(),a==null||a(!1)},p=i.useCallback((v,w)=>{if(l(v),h(w),console.log(`Timeline changed to: ${v}/${w}`),t.current&&v&&w){const N=t.current.getGlobe();D(N);const y=z();let f;n.size>0?f=$(Array.from(n),v,w):f=$(y,v,w),s(f),A(N,f)}},[t,n]),d=()=>n.size>0?Array.from(n):z();return e.jsxs("div",{className:"timeline-controls-container",children:[e.jsx(me,{onToggleTimelineMode:j,isTimelineMode:r}),e.jsx(ge,{onTimelineChange:p,currentMonth:m,currentYear:o,isVisible:r,availableSharks:d(),plottedCoordinates:g})]})},ve=({shark:t})=>{const n=t.image!=="Unknown"?ee(t.image):[];return e.jsxs("div",{className:"shark-banner",children:[e.jsx("div",{className:"tiny-banner-media",children:n.length>0?e.jsx("img",{src:n[0].url,alt:`Image of shark ${t.id}`}):e.jsx("span",{className:"no-image",children:"N/A"})}),e.jsxs("div",{className:"tiny-id-row",children:[e.jsx("strong",{children:t.id}),e.jsx(ne,{sharkId:t.id})]})]})};function xe({sharks:t,onSelect:n,selectedSharkId:u,viewMode:r,selectedSharksForLab:a,onLabSelectionChange:m}){const[l,o]=i.useState(new Set),[h,g]=i.useState(!1);i.useEffect(()=>{const d=()=>{o(V()),g(!0)};return d(),window.addEventListener("storage",d),window.addEventListener("favoritesChanged",d),()=>{window.removeEventListener("storage",d),window.removeEventListener("favoritesChanged",d)}},[]);const s=i.useMemo(()=>{if(l.size===0)return[];const d=new Map(t.map(v=>[v.id,v]));return[...l].map(v=>d.get(v)).filter(Boolean).sort((v,w)=>v.id.localeCompare(w.id))},[t,l]),j=d=>{r==="multiple"?p(d.id):n&&n(d.id)},p=i.useCallback(d=>{if(m&&a){const v=new Set(a);v.has(d)?v.delete(d):v.add(d),m(v)}},[m,a]);return e.jsxs("div",{className:"saved-sharks-display",children:[e.jsx("div",{className:"saved-sharks-header",children:e.jsxs("h3",{children:["Saved Sharks (",s.length,")"]})}),s.length>0?e.jsx("div",{className:"scrollable-shark-list",children:e.jsx("div",{className:"saved-sharks-grid",children:s.map(d=>{const v=a&&a.has(d.id);return e.jsx("div",{className:`saved-shark-card-wrapper ${r==="individual"&&d.id===u?"selected":""} ${r==="multiple"&&v?"selected-for-lab":""}`,onClick:()=>j(d),children:e.jsx(ve,{shark:d})},d.id)})})}):h&&l.size===0?e.jsxs("div",{className:"no-sharks-message",children:["Sorry! No whale sharks match your current filters.",e.jsx("br",{}),e.jsx("br",{}),"Use the ⭐ button to save sharks while browsing!"]}):null]})}function pe(t){if(t.countries){const n=t.countries.split(",")[0];return W(n)}return"Unknown"}function Se(t){if(t.newest)return new Date(t.newest).getFullYear();if(t.oldest)return new Date(t.oldest).getFullYear();if(t.countries){const n=te(t.countries);if(n!=="Unknown"){const u=n.match(/(\d{4})/);if(u)return parseInt(u[1])}}return new Date().getFullYear()}function we(t){if(t.publishing){const n=t.publishing.split(",")[0];return W(n)}return"Unknown"}function je(t){if(t.length===0)return[{lab:"No sharks selected","Total Selected":0,"Total Occurrences":0,Countries:"N/A",Years:"N/A","Top 3 Publishing Countries":"N/A"}];const n=new Set,u=new Set,r=new Map;let a=0;t.forEach(h=>{n.add(pe(h)),u.add(Se(h));const g=h.occurrences||1;a+=g;const s=we(h);s!=="Unknown"&&r.set(s,(r.get(s)||0)+1)});const m=Array.from(r.entries()).sort((h,g)=>g[1]-h[1]).slice(0,3).map(([h])=>h).join(" > "),l=Array.from(u),o=Array.from(n);return[{lab:`${t.length} Selected Sharks`,"Total Selected":t.length,"Total Occurrences":a,Countries:o.slice(0,3).join(", ")+(o.length>3?"...":""),Years:l.length>0?`${Math.min(...l)} - ${Math.max(...l)}`:"N/A","Unique Countries":o.length,"Year Range":l.length>0?Math.max(...l)-Math.min(...l)+1:0,"Top 3 Publishing Countries":m||"Unknown"}]}function be(t){if(!t||t.size===0)return[];const n=new Map;Array.from(t).forEach(a=>{const m=O.find(l=>l.whaleSharkID===a);m&&m.coordinates&&m.coordinates.forEach(l=>{if(l.eventDate){const o=new Date(l.eventDate);if(!isNaN(o.getTime())){const h=o.getFullYear(),g=Y[o.getMonth()],s=`${h}-${g}`;n.set(s,(n.get(s)||0)+1)}}})});const r=[];for(const[a,m]of n.entries()){const[l,o]=a.split("-");r.push({year:parseInt(l),month:o,value:m})}return r}function Ne({selectedSharksForLab:t,savedIds:n,sharks:u,onSelectAllToggle:r}){const a=i.useMemo(()=>t.size===0?[]:u.filter(o=>t.has(o.id)),[t,u]),m=i.useMemo(()=>a.length===0?[]:je(a),[a]),l=i.useMemo(()=>t.size===0?[]:be(t),[t]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"multi-select-info",children:[e.jsxs("div",{className:"multi-select-header",children:[e.jsxs("h4",{children:["Selected for Lab (",t.size,"):"]}),e.jsxs("label",{className:"select-all-container",children:[e.jsx("input",{type:"checkbox",checked:t.size>0&&Array.from(n).every(o=>t.has(o)),onChange:r,className:"select-all-checkbox"}),"Add all saved whale sharks"]})]}),e.jsx("div",{className:"selected-sharks-list",children:t.size>0?Array.from(t).join(", "):"None in lab"})]}),e.jsx("div",{className:"overview-container",children:e.jsx(ce,{dataset:m,filterField:"lab",selectedFilter:t.size>0?`${t.size} Selected Sharks`:"",displayFields:[{label:"Total Occurrences",field:"Total Occurrences"},{label:"Top 3 Publishing Countries",field:"Top 3 Publishing Countries"}]})}),e.jsx("div",{className:"heatmap-container",children:t.size>0&&l.length>0?e.jsx(de,{data:l,title:"Lab Sharks Record Timeline"}):e.jsx(oe,{type:"heatmap",message:"Add sharks to lab for heatmap"})}),e.jsx("div",{className:"radial-heatmap-container",children:e.jsx(ue,{sharks:a})})]})}function Ye(){const[t,n]=i.useState(null),[u,r]=i.useState(!0),[a,m]=i.useState(q),[l,o]=i.useState(new Set),[h,g]=i.useState("multiple"),[s,j]=i.useState(new Set),[p,d]=i.useState(!1),[v,w]=i.useState(0),[N,y]=i.useState(null),f=i.useRef(),[x,S]=i.useState(!1),[b,k]=i.useState(null),[M,I]=i.useState(null),P=q;i.useEffect(()=>{const c=()=>{o(V())};return c(),window.addEventListener("storage",c),window.addEventListener("favoritesChanged",c),()=>{window.removeEventListener("storage",c),window.removeEventListener("favoritesChanged",c)}},[]);const T=i.useMemo(()=>{const c=z(),C=a.map(E=>E.id),B=[...new Set(c)],F=[...new Set(C)];console.log("Unique sharks from saved IDs:",B),console.log("Unique sharks from filtered IDs:",F);const R=B.filter(E=>F.includes(E));return console.log("Plotting sharks on globe:",R),H(R)},[l,a]),G=i.useMemo(()=>{if(s.size===0)return[];const c=Array.from(s);return console.log("Plotting selected lab sharks on globe:",c),x&&b&&M?$(c,b,M):H(c)},[s,x,b,M]);i.useEffect(()=>{if(!f.current)return;const c=f.current.getGlobe();if(D(c),p){r(!1);return}if(x){r(!1);return}h==="individual"?t?(f.current.highlightShark(t.id,!0),r(!1)):(A(c,T),r(!0)):s.size>0?(A(c,G),r(!0)):(A(c,T),r(!0))},[h,t,T,G,p]);const U=ie({sharks:P,pointsData:T,allSharksVisible:u,onSharkSelect:n}),J=()=>{n(null),r(!0)},Q=()=>{if(p){if(d(!1),w(0),y(null),f.current){const c=f.current.getGlobe();if(D(c),f.current.enableControls(),t){const C=K(t.id);A(c,C)}}}else if(d(!0),w(0),f.current&&t){f.current.disableControls();const c=f.current.getGlobe();D(c)}},X=i.useCallback((c,C)=>{w(c),y(C),f.current&&C&&f.current.showSinglePoint(C)},[]),Z=()=>{s.size>0&&Array.from(l).every(c=>s.has(c))?j(new Set):j(new Set(l))},_=()=>{if(n(null),j(new Set),r(!0),p&&(d(!1),w(0),y(null),f.current&&f.current.enableControls()),x&&(S(!1),k(null),I(null)),f.current){const c=f.current.getGlobe();D(c)}g(c=>c==="individual"?"multiple":"individual")},L=()=>{x?(S(!1),k(null),I(null)):S(!0)};return e.jsx("div",{className:"page-content globeviews-wrapper",children:e.jsxs("div",{className:"globe-views-container",children:[e.jsxs("div",{className:"info-sidebar",children:[e.jsx("button",{className:`view-mode-toggle ${h}`,onClick:_,children:h==="individual"?"Switch to Multi Shark View":"Switch to Single Shark View"}),t&&e.jsxs("div",{className:"story-controls-container",children:[e.jsx(ae,{shark:t,onToggleStepMode:Q,isStepMode:p,showPauseForGeoLabs:!0}),e.jsx(he,{shark:t,onStepChange:X,currentStepIndex:v,isVisible:p})]}),h==="multiple"&&e.jsx(fe,{globeRef:f,selectedSharksForLab:s,onToggleTimelineMode:L,isTimelineMode:x}),h==="multiple"?e.jsx("div",{className:"shark-info-panel",children:e.jsx(Ne,{selectedSharksForLab:s,savedIds:l,sharks:P,onSelectAllToggle:Z})}):e.jsx(re,{shark:t})]}),e.jsxs("div",{className:"globe-container",children:[e.jsx(se,{ref:f,onSharkClick:U,allowClicks:h==="individual"&&!t}),p&&N&&e.jsxs("div",{style:{position:"absolute",bottom:10,width:"100%",textAlign:"center",color:"white",fontSize:"0.85rem",fontFamily:"sans-serif",padding:"2px 0",backgroundColor:"rgba(0, 0, 0, 0)",textShadow:"0 0 8px rgba(0, 255, 255, 0.9)",pointerEvents:"none",userSelect:"none"},children:["Lat: ",e.jsx("span",{style:{fontWeight:"bold"},children:N.lat.toFixed(3)}),","," ","Lng: ",e.jsx("span",{style:{fontWeight:"bold"},children:N.lng.toFixed(3)})," —"," ","Date: ",e.jsx("span",{style:{fontWeight:"bold"},children:N.date||"N/A"})]})]}),e.jsx("div",{className:"shark-selector",children:e.jsx(le,{sharks:P,onSelect:U,onReset:J,selectedSharkId:t?t.id:null,DisplayComponent:c=>e.jsx(xe,{...c,viewMode:h,selectedSharksForLab:s,onLabSelectionChange:j,onSelect:h==="multiple"?null:c.onSelect}),disabled:p||x,onFilteredSharksChange:m})})]})})}export{Ye as default};
